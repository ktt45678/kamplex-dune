<ng-container *transloco="let t">
  <media-player #player aspect-ratio="16/9" autoplay crossorigin keep-alive>
    <media-outlet></media-outlet>
    <media-captions></media-captions>
    <ng-container *ngIf="playerStore">
      <div *ngIf="!playerStore.canPlay || playerStore.waiting" class="tw-absolute tw-absolute-center tw-z-1"
        aria-label="Loading media">
        <p-progressSpinner strokeWidth="3px"></p-progressSpinner>
      </div>
      <div *ngIf="isMobile" class="media-controls player-center-controls tw-absolute tw-absolute-center tw-z-3
        tw-transition-opacity tw-ease-linear tw-duration-200" aria-label="Mobile center controls">
        <ng-container *ngTemplateOutlet="playButtonTpl; context: { styleClass: 'tw-w-24 sm:tw-w-32' }">
        </ng-container>
      </div>
      <div class="media-controls tw-text-white tw-absolute tw-inset-0 tw-flex tw-flex-col tw-justify-between tw-z-2
        tw-transition-opacity tw-duration-200 tw-ease-linear focus-within:tw-opacity-100" role="group"
        aria-label="Media controls">
        <div class="tw-flex" [ngClass]="{ 'tw-h-32 tw-bg-gradient-to-b tw-from-black/60 tw-to-transparent': isMobile }">
          <div class="tw-ml-auto">
            <ng-container *ngIf="isMobile">
              <ng-container *ngTemplateOutlet="subtitleButtonTpl"></ng-container>
              <ng-container *ngTemplateOutlet="settingsButtonTpl; context: {
                  menuPosition: [ { originX: 'center', originY: 'bottom', overlayX: 'center', overlayY: 'bottom' } ],
                  menuRelativeTo: 'body', lockedPosition: false
                }"></ng-container>
            </ng-container>
          </div>
        </div>
        <div class="tw-flex tw-flex-wrap tw-content-end tw-h-64 tw-bg-gradient-to-t tw-from-black/60 tw-to-transparent">
          <media-time-slider step="1">
            <div slot="preview">
              <media-slider-thumbnail [attr.src]="previewThumbnail" cdn="https://wsrv.nl/?url={url}&q=90" />
              <media-slider-value type="pointer" format="time" />
            </div>
          </media-time-slider>
          <div #bottomControls role="group" class="player-bottom-controls tw-flex tw-justify-between tw-w-full"
            (mouseleave)="isVolumeCtrlActive = false">
            <div class="tw-flex tw-items-center" aria-label="Left controls">
              <ng-container *ngIf="!isMobile">
                <ng-container *ngTemplateOutlet="playButtonTpl; context: { styleClass: 'tw-w-14 tw-p-2' }">
                </ng-container>
              </ng-container>
              <div *ngIf="!isMobile" class="player-volume-area tw-flex tw-items-center"
                [ngClass]="{ 'player-volume-area-active': isVolumeCtrlActive}" (mouseenter)="isVolumeCtrlActive = true">
                <button class="media-mute-button tw-w-14 tw-p-2 focus-visible:tw-shadow-focus-box"
                  aria-label="Mute audio" aria-keyshortcuts="m" (click)="toggleMute()">
                  <svg *ngIf="playerStore.muted || playerStore.volume === 0; else notMutedTpl" slot="volume-muted"
                    viewBox="0 0 36 36" fill="white">
                    <path
                      d="M 18 10 L 15.91 12.09 L 18 14.18 M 10.27 9 L 9 10.27 L 13.73 15 L 9 15 L 9 21 L 13 21 L 18 26 L 18 19.27 L 22.25 23.53 C 21.58 24.04 20.83 24.46 20 24.7 L 20 26.77 C 21.38 26.45 22.63 25.82 23.68 24.96 L 25.73 27 L 27 25.73 L 18 16.73 M 25 18 C 25 18.94 24.8 19.82 24.46 20.64 L 25.97 22.15 C 26.62 20.91 27 19.5 27 18 C 27 13.72 24 10.14 20 9.23 L 20 11.29 C 22.89 12.15 25 14.83 25 18 M 22.5 18 C 22.5 16.23 21.5 14.71 20 13.97 L 20 16.18 L 22.45 18.63 C 22.5 18.43 22.5 18.21 22.5 18 Z" />
                  </svg>
                  <ng-template #notMutedTpl>
                    <svg *ngIf="playerStore.volume < 0.5; else highVolumeTpl" slot="volume-low" viewBox="0 0 36 36"
                      fill="white">
                      <path
                        d="M 22.5 18 C 22.5 16.23 21.5 14.71 20 13.97 L 20 22 C 21.5 21.29 22.5 19.76 22.5 18 M 9 15 L 9 21 L 13 21 L 18 26 L 18 10 L 13 15 L 9 15 Z" />
                    </svg>
                  </ng-template>
                  <ng-template #highVolumeTpl>
                    <svg slot="volume-high" viewBox="0 0 36 36" fill="white">
                      <path
                        d="M 20 9.23 L 20 11.29 C 22.89 12.15 25 14.83 25 18 C 25 21.17 22.89 23.84 20 24.7 L 20 26.77 C 24 25.86 27 22.28 27 18 C 27 13.72 24 10.14 20 9.23 M 22.5 18 C 22.5 16.23 21.5 14.71 20 13.97 L 20 22 C 21.5 21.29 22.5 19.76 22.5 18 M 9 15 L 9 21 L 13 21 L 18 26 L 18 10 L 13 15 L 9 15 Z" />
                    </svg>
                  </ng-template>
                </button>
                <media-volume-slider class="tw-w-0 tw-transition-width-height tw-duration-200" key-step="5">
                  <media-slider-value type="pointer" format="percent" slot="preview" />
                </media-volume-slider>
              </div>
              <div class="[&>*]:tw-text-sm" [class]="isMobile ? 'tw-ml-4' : 'tw-ml-2'">
                <media-time type="current" class="tw-inline tw-font-normal"></media-time>
                <span class="tw-mx-1">/</span>
                <media-time type="duration" class="tw-inline tw-font-normal"></media-time>
              </div>
            </div>
            <div class="tw-flex tw-items-center" aria-label="Right controls">
              <ng-container *ngIf="!isMobile">
                <ng-container *ngTemplateOutlet="subtitleButtonTpl"></ng-container>
                <ng-container *ngTemplateOutlet="settingsButtonTpl; context: {
                  menuPosition: [ { originX: 'end', originY: 'top', overlayX: 'end', overlayY: 'bottom' } ],
                  menuRelativeTo: bottomControls, offsetX: -10, offsetY: -20, flexibleDimensions: false
                }"></ng-container>
              </ng-container>
              <button type="button" class="media-fullscreen-button tw-w-14 tw-p-2 focus-visible:tw-shadow-focus-box"
                aria-label="Fullscreen" aria-keyshortcuts="f"
                [attr.data-fullscreen]="playerStore.fullscreen ? '' : null" (click)="toggleFullscreen()">
                <svg *ngIf="!playerStore.fullscreen; else isFullscreenTpl" slot="enter" width="100%" height="100%"
                  version="1.1" viewBox="0 0 36 36" fill="white">
                  <g class="fullscreen-button-corner-0">
                    <path d="m 10,16 2,0 0,-4 4,0 0,-2 L 10,10 l 0,6 0,0 z"></path>
                  </g>
                  <g class="fullscreen-button-corner-1">
                    <path d="m 20,10 0,2 4,0 0,4 2,0 L 26,10 l -6,0 0,0 z"></path>
                  </g>
                  <g class="fullscreen-button-corner-2">
                    <path d="m 24,24 -4,0 0,2 L 26,26 l 0,-6 -2,0 0,4 0,0 z"></path>
                  </g>
                  <g class="fullscreen-button-corner-3">
                    <path d="M 12,20 10,20 10,26 l 6,0 0,-2 -4,0 0,-4 0,0 z"></path>
                  </g>
                </svg>
                <ng-template #isFullscreenTpl>
                  <svg slot="exit" width="100%" height="100%" version="1.1" viewBox="0 0 36 36" fill="white">
                    <g class="fullscreen-button-corner-0">
                      <path d="m 20,26 2,0 0,-4 4,0 0,-2 -6,0 0,6 0,0 z"></path>
                    </g>
                    <g class="fullscreen-button-corner-1">
                      <path d="m 10,22 4,0 0,4 2,0 0,-6 -6,0 0,2 0,0 z"></path>
                    </g>
                    <g class="fullscreen-button-corner-2">
                      <path d="m 14,14 -4,0 0,2 6,0 0,-6 -2,0 0,4 0,0 z"></path>
                    </g>
                    <g class="fullscreen-button-corner-3">
                      <path d="m 22,14 0,-4 -2,0 0,6 6,0 0,-2 -4,0 0,0 z"></path>
                    </g>
                  </svg>
                </ng-template>
              </button>
            </div>
          </div>
        </div>
      </div>
      <ng-template #playButtonTpl let-tplStyleClass="styleClass">
        <button type="button" class="media-play-button focus-visible:tw-shadow-focus-box" aria-label="Play/Pause"
          [class]="tplStyleClass" aria-keyshortcuts="k Space" [attr.data-paused]="playerStore.paused ? '' : null"
          (click)="togglePlay()">
          <svg slot="play" aria-hidden="true" viewBox="0 0 36 36" fill="white">
            <path d="M 12,26 18.5,22 18.5,14 12,10 z M 18.5,22 25,18 25,18 18.5,14 z"
              class="tw-transition-all tw-duration-200" />
          </svg>
        </button>
      </ng-template>
      <ng-template #subtitleButtonTpl>
        <button type="button" class="media-subtitle-button tw-w-14 tw-p-2 focus-visible:tw-shadow-focus-box"
          [ngClass]="{ 'tw-opacity-30': !tracks?.length }" aria-label="Enable/disable subtitle" aria-keyshortcuts="c"
          (click)="toggleSubtitle()">
          <svg *ngIf="!trackDisabled; else trackDisabledTpl" slot="enabled" width="100%" height="100%" version="1.1"
            viewBox="0 0 36 36" fill="white">
            <path
              d="M 26 10 L 10 10 C 8.895 10 8 10.895 8 12 L 8 24 C 8 25.105 8.895 26 10 26 L 26 26 C 27.105 26 28 25.105 28 24 L 28 12 C 28 10.895 27.105 10 26 10 M 10 18 L 14 18 L 14 20 L 10 20 L 10 18 M 20 24 L 10 24 L 10 22 L 20 22 L 20 24 M 26 24 L 22 24 L 22 22 L 26 22 L 26 24 M 26 20 L 16 20 L 16 18 L 26 18 L 26 20 Z" />
          </svg>
          <ng-template #trackDisabledTpl>
            <svg slot="disabled" width="100%" height="100%" version="1.1" viewBox="0 0 36 36" fill="white">
              <path
                d="M 26 10 C 27.105 10 28 10.895 28 12 L 28 24 C 28 25.105 27.105 26 26 26 L 10 26 C 8.895 26 8 25.105 8 24 L 8 12 C 8 10.895 8.895 10 10 10 L 26 10 M 26 24 L 26 12 L 10 12 L 10 24 L 26 24 M 12 16 L 14 16 L 14 18 L 12 18 L 12 16 M 12 20 L 20 20 L 20 22 L 12 22 L 12 20 M 22 20 L 24 20 L 24 22 L 22 22 L 22 20 M 16 16 L 24 16 L 24 18 L 16 18 L 16 16 Z" />
            </svg>
          </ng-template>
        </button>
      </ng-template>
      <ng-template #settingsButtonTpl let-tplMenuPosition="menuPosition" let-tplMenuRelativeTo="menuRelativeTo"
        let-tplOffsetX="offsetX" let-tplOffsetY="offsetY" let-tplLockedPosition="lockedPosition"
        let-tplFlexibleDimensions="flexibleDimensions">
        <button type="button" class="media-settings-button tw-w-14 tw-p-2 focus-visible:tw-shadow-focus-box"
          aria-label="Settings" [slideMenuTriggerFor]="settingsMenu" [menuRelativeTo]="tplMenuRelativeTo"
          [offsetX]="tplOffsetX" [offsetY]="tplOffsetY" [lockedPosition]="tplLockedPosition"
          [flexibleDimensions]="tplFlexibleDimensions" #settingsMenuButton #settingsMenuTrigger="slideMenuTriggerFor"
          [menuPosition]="tplMenuPosition" (menuOpened)="onSettingsMenuClick(settingsMenuButton, true)"
          (menuClosed)="onSettingsMenuClick(settingsMenuButton, false)">
          <svg slot="show" width="100%" height="100%" version="1.1" viewBox="0 0 36 36" fill="white"
            class="tw-transition-transform tw-duration-200">
            <path
              d="M 18.002 21.5 C 16.069 21.5 14.502 19.933 14.502 18 C 14.502 16.067 16.069 14.5 18.002 14.5 C 19.935 14.5 21.502 16.067 21.502 18 C 21.502 19.933 19.935 21.5 18.002 21.5 M 25.432 18.97 C 25.472 18.65 25.502 18.33 25.502 18 C 25.502 17.67 25.472 17.34 25.432 17 L 27.542 15.37 C 27.732 15.22 27.782 14.95 27.662 14.73 L 25.662 11.27 C 25.542 11.05 25.272 10.96 25.052 11.05 L 22.562 12.05 C 22.042 11.66 21.502 11.32 20.872 11.07 L 20.502 8.42 C 20.462 8.18 20.252 8 20.002 8 L 16.002 8 C 15.752 8 15.542 8.18 15.502 8.42 L 15.132 11.07 C 14.502 11.32 13.962 11.66 13.442 12.05 L 10.952 11.05 C 10.732 10.96 10.462 11.05 10.342 11.27 L 8.342 14.73 C 8.212 14.95 8.272 15.22 8.462 15.37 L 10.572 17 C 10.532 17.34 10.502 17.67 10.502 18 C 10.502 18.33 10.532 18.65 10.572 18.97 L 8.462 20.63 C 8.272 20.78 8.212 21.05 8.342 21.27 L 10.342 24.73 C 10.462 24.95 10.732 25.03 10.952 24.95 L 13.442 23.94 C 13.962 24.34 14.502 24.68 15.132 24.93 L 15.502 27.58 C 15.542 27.82 15.752 28 16.002 28 L 20.002 28 C 20.252 28 20.462 27.82 20.502 27.58 L 20.872 24.93 C 21.502 24.67 22.042 24.34 22.562 23.94 L 25.052 24.95 C 25.272 25.03 25.542 24.95 25.662 24.73 L 27.662 21.27 C 27.782 21.05 27.732 20.78 27.542 20.63 L 25.432 18.97 Z" />
          </svg>
        </button>
      </ng-template>
    </ng-container>
    <ng-template #settingsMenu>
      <app-slide-menu class="media-menu" [ngClass]="{ 'tw-w-96': isMobile }">
        <!--button slideMenuItemCheckbox [menuItemChecked]="true">
          <i class="ms ms-queue-play-next"></i>
          <span>{{ t('player.menu.autoNext') }}</span>
          <i role="checkbox" class="ms ms-icon-sm ms-check tw-ml-auto"></i>
        </button-->
        <button slideMenuItem [slideMenuTriggerFor]="playbackSpeedMenu">
          <i class="ms ms-slow-motion-video"></i>
          <span>{{ t('player.menu.speed') }}</span>
        </button>
        <button slideMenuItem [slideMenuTriggerFor]="qualityMenu">
          <i class="ms ms-tune"></i>
          <span>{{ t('player.menu.quality') }}</span>
        </button>
        <button *ngIf="tracks?.length" slideMenuItem [slideMenuTriggerFor]="subtitleMenu">
          <i class="ms ms-subtitles"></i>
          <span>{{ t('player.menu.subtitle') }}</span>
        </button>
      </app-slide-menu>
    </ng-template>
    <ng-template #playbackSpeedMenu>
      <app-slide-menu class="media-menu p-scrollbar tw-overflow-y-auto" [ngClass]="{ 'tw-w-96': isMobile }"
        [backLabel]="t('player.menu.speed')">
        <button *ngFor="let speed of playbackSpeeds" slideMenuItemRadio [menuItemChecked]="activeSpeedValue === speed"
          (click)="setPlaybackSpeed(speed)">
          <i role="checkbox" class="ms ms-icon-sm ms-check"></i>
          <span>{{ speed === 1 ? t('player.speed.normal') : speed }}</span>
        </button>
      </app-slide-menu>
    </ng-template>
    <ng-template #qualityMenu>
      <app-slide-menu class="media-menu p-scrollbar tw-max-h-80 tw-overflow-y-auto" [ngClass]="{ 'tw-w-96': isMobile }"
        [backLabel]="t('player.menu.quality')">
        <button *ngFor="let source of sources; let i = index; trackBy: track_Id" slideMenuItemRadio
          [menuItemChecked]="activeSourceIndex === i" (click)="changePlayerQuality(i)">
          <i role="checkbox" class="ms ms-icon-sm ms-check"></i>
          <span>{{ source.size }}p</span>
        </button>
      </app-slide-menu>
    </ng-template>
    <ng-template #subtitleMenu>
      <app-slide-menu class="media-menu p-scrollbar tw-max-h-80 tw-overflow-y-auto" [ngClass]="{ 'tw-w-96': isMobile }"
        [backLabel]="t('player.menu.subtitle')">
        <button slideMenuItemRadio [menuItemChecked]="trackDisabled" (click)="setPlayerTrack(null)">
          <i role="checkbox" class="ms ms-icon-sm ms-check"></i>
          <span>{{ t('player.subtitles.off') }}</span>
        </button>
        <button *ngFor="let track of tracks; trackBy: track_Id" slideMenuItemRadio
          [menuItemChecked]="!trackDisabled && activeTrackValue === track.lang" (click)="setPlayerTrack(track.lang)">
          <i role="checkbox" class="ms ms-icon-sm ms-check"></i>
          <span>{{ track.label }}</span>
        </button>
      </app-slide-menu>
    </ng-template>
  </media-player>
</ng-container>
