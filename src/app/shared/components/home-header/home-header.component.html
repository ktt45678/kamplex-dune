<header>
  <ng-container *transloco="let t">
    <nav id="navbar" class="tw-z-10 tw-bg-neutral-900" [ngClass]="{ 'tw-fixed tw-top-0 tw-left-0 tw-right-0 tw-transition-top':
      isFixedNavbar, 'tw-bg-opacity-60': !isMobileMenuOpened, 'tw-bg-opacity-100': isMobileMenuOpened }">
      <div class="tw-max-w-8xl tw-mx-auto tw-px-4 sm:tw-px-6 lg:tw-px-8">
        <div class="tw-relative tw-flex tw-justify-between tw-h-14">
          <div class="tw-flex tw-items-center tw-flex-initial tw-basis-full">
            <!-- Desktop menu button -->
            <button pButton [appMenuTriggerFor]="desktopMenu" icon="ms ms-menu" type="button"
              aria-label="Toggle desktop menu"
              [ngClass]="displayMobileSearch ? 'lg:tw-inline-flex' : 'sm:tw-inline-flex'"
              class="p-button-rounded p-button-text p-button-secondary p-button-sm p-button-sm-icon tw-hidden">
            </button>
            <!--p-tieredMenu #browseMenu [popup]="true" [appendTo]="menuZone" [model]="browseMenuItems"
              showTransitionOptions="0s linear"></p-tieredMenu-->
            <!-- Mobile menu button -->
            <button pButton (click)="toggleMobileMenu()" icon="ms ms-menu" type="button" aria-label="Toggle mobile menu"
              class="p-button-rounded p-button-text p-button-secondary p-button-sm p-button-sm-icon sm:tw-hidden"
              [ngClass]="displayMobileSearch ? 'tw-hidden lg:tw-inline-flex' : 'tw-inline-flex'">
            </button>
            <!-- Home page button -->
            <a routerLink="/" routerLinkActive="ms-fill" [routerLinkActiveOptions]="{exact: true}"
              [ngClass]="displayMobileSearch ? 'tw-hidden lg:tw-block' : 'tw-block'">
              <button pButton type="button" role="navigation" icon="ms ms-home tw-text-[#F27649] -tw-mt-px"
                aria-label="Home page"
                class="p-button-rounded p-button-text p-button-secondary p-button-sm p-button-sm-icon">
              </button>
            </a>
            <a routerLink="/" [ngClass]="displayMobileSearch ? 'tw-hidden lg:tw-block' : 'tw-block'">
              <img class="tw-h-3 md:tw-h-4 tw-w-auto" src="assets/images/logo-text.png" alt="KamPlex">
            </a>
            <button *ngIf="displayMobileSearch" pButton type="button" icon="ms ms-arrow-back"
              aria-label="Hide mobile search"
              class="p-button-rounded p-button-text p-button-secondary p-button-sm p-button-sm-icon lg:tw-hidden"
              (click)="toggleMobileSearch()">
            </button>
            <div class="lg:tw-ml-4" [ngClass]="{ 'tw-w-full lg:tw-w-auto': displayMobileSearch }">
              <div class="tw-flex tw-items-center">
                <span class="p-input-button-left tw-w-full lg:tw-w-80"
                  [ngClass]="displayMobileSearch ? 'tw-inline-flex' : 'tw-hidden lg:tw-inline-flex tw-mr-2'">
                  <button pButton type="button" icon="ms ms-search" aria-label="Search"
                    class="p-button-rounded p-button-text p-button-secondary p-button-sm p-button-sm-icon tw-ml-0.5"
                    (click)="loadAdvancedSearch(mediaSearch.inputValue)">
                  </button>
                  <p-autoComplete #mediaSearch [suggestions]="mediaSuggestions"
                    [placeholder]="t('homeHeader.searchPlaceholder')" [minLength]="2" [maxlength]="250"
                    (completeMethod)="loadMediaSuggestions($event.query)" field="title" dataKey="_id"
                    [completeOnFocus]="false" [showEmptyMessage]="true" scrollHeight="480px" class="p-autocomplete-full"
                    styleClass="p-inputtext-xs p-inputtext-rounded" panelStyleClass="p-autocomplete-xs" inputId="media"
                    ariaLabel="Find media" dropdownAriaLabel="Media search results"
                    (onKeyUp)="onMediaSearchKeyUp($event, mediaSearch)">
                    <ng-template let-media pTemplate="item">
                      <a class="tw-flex" [routerLink]="['/details', media._id]">
                        <div class="tw-w-12">
                          <div class="tw-aspect-w-2 tw-aspect-h-3 tw-rounded-sm tw-overflow-hidden">
                            <img *ngIf="media.smallPosterUrl; else noPoster" class="tw-object-cover"
                              [lazyLoad]="media.smallPosterUrl" [lazyLoadPlaceholder]="media.posterColor | rgbColor"
                              [alt]="media.title" errorImage="assets/images/media-poster-sm.png">
                            <ng-template #noPoster>
                              <img class="tw-object-cover" src="assets/images/media-poster-sm.png" loading="lazy"
                                [alt]="media.title">
                            </ng-template>
                          </div>
                        </div>
                        <div class="tw-text-white tw-flex-1 tw-mx-2 tw-text-sm">
                          <p class="tw-font-bold tw-whitespace-normal tw-line-clamp-2">{{ media.title }}</p>
                          <div class="tw-flex tw-items-center tw-text-gray-300 tw-mt-2">
                            <i class="ms ms-calendar-today ms-icon-sm tw-mr-1.5"></i>
                            <p class="tw-font-semibold tw-mr-2">{{ media.releaseDate.year }}</p>
                            <i class="ms ms-schedule ms-icon-sm tw-mr-1.5"></i>
                            <p class="tw-font-semibold tw-mr-2">{{ media.runtime * 1000 | time:{ display:'short' }
                              }}</p>
                          </div>
                        </div>
                      </a>
                    </ng-template>
                  </p-autoComplete>
                </span>
                <!--a routerLink="/media" routerLinkActive="before:tw-bg-white" class="tw-nav-item tw-hidden"
                  [ngClass]="displayMobileSearch ? 'lg:tw-block' : 'sm:tw-block'">{{ t('homeHeader.movies')
                  }}</a-->
                <!--a routerLink="/media" routerLinkActive="before:tw-bg-white" class="tw-nav-item tw-hidden"
                  [ngClass]="displayMobileSearch ? 'lg:tw-block' : 'sm:tw-block'">{{ t('homeHeader.tvShows')
                  }}</a-->
                <!--a routerLink="/search" routerLinkActive="before:tw-bg-white" class="tw-nav-item">{{
                  t('homeHeader.search') }}</a-->
              </div>
            </div>
          </div>
          <div class="tw-flex tw-items-center tw-ml-auto tw-pr-2 sm:tw-pr-0 tw-flex-shrink-0 tw-basis-auto">
            <button *ngIf="displayMobileSearch" pButton type="button" icon="ms ms-close" aria-label="Clear search input"
              class="p-button-rounded p-button-text p-button-secondary p-button-sm p-button-sm-icon lg:tw-hidden"
              (click)="clearSearchInput()" [disabled]="!mediaSearch.inputValue">
            </button>
            <button *ngIf="!displayMobileSearch" pButton type="button" icon="ms ms-search"
              aria-label="Show mobile search"
              class="p-button-rounded p-button-text p-button-secondary p-button-sm p-button-sm-icon lg:tw-hidden"
              (click)="toggleMobileSearch()">
            </button>
            <div class="tw-hidden tw-items-center" [ngClass]="displayMobileSearch ? 'lg:tw-flex' : 'sm:tw-flex'">
              <ng-container *ngIf="currentUser; else notLoggedIn">
                <a type="button" role="navigation" aria-label="User profile" class="tw-flex tw-items-center tw-rounded-full
                    tw-p-1 hover:tw-bg-neutral-650 focus-visible:tw-outline-none focus-visible:tw-shadow-focus-box
                    tw-transition-colors tw-duration-200 tw-ml-2" [routerLink]="['/users', currentUser._id]">
                  <ng-container *ngTemplateOutlet="userButton; context: { currentUser }"></ng-container>
                </a>
                <button pButton type="button" icon="ms ms-more-vert" aria-label="User menu"
                  [appMenuTriggerFor]="userMenu"
                  class="p-button-rounded p-button-text p-button-secondary p-button-sm p-button-sm-icon tw-ml-2">
                </button>
                <!--p-menu #userMenu [popup]="true" [appendTo]="menuZone" [model]="userMenuItems"
                  showTransitionOptions="0s linear"></p-menu-->
                <ng-template #userMenu>
                  <div appMenu>
                    <ng-container *ngIf="currentUser | isGranted:UserPermission.MANAGE_MEDIA">
                      <a appMenuItem routerLink="/admin/media">
                        <i class="ms ms-movie"></i>
                        <span>{{ t('homeHeader.manageMedia') }}</span>
                      </a>
                      <a appMenuItem routerLink="/">
                        <i class="ms ms-settings"></i>
                        <span>{{ t('homeHeader.settings') }}</span>
                      </a>
                    </ng-container>
                    <button appMenuItem (click)="onSignOut()">
                      <i class="ms ms-logout"></i>
                      <span>{{ t('homeHeader.signOut') }}</span>
                    </button>
                  </div>
                </ng-template>
              </ng-container>
              <ng-template #notLoggedIn>
                <a routerLink="/sign-in" routerLinkActive="before:tw-bg-white" class="tw-nav-item">{{
                  t('homeHeader.signIn') }}</a>
              </ng-template>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile menu, show/hide based on menu state. -->
      <!-- Current: "tw-bg-gray-900 tw-text-white", Default: "tw-text-gray-300 hover:tw-bg-gray-700 hover:tw-text-white" -->
      <!-- <div class="tw-bg-neutral-900 sm:tw-hidden" [ngClass]="isMobileMenuOpened ? 'tw-block' : 'tw-hidden'">
        <div class="tw-px-2 tw-pt-2 tw-pb-3 tw-space-y-1">
          <button role="navigation" pButton routerLink="/" class="p-button-text p-button-secondary tw-block tw-w-full"
            [label]="t('homeHeader.home')" (click)="toggleMobileMenu()"></button>
          <button role="navigation" pButton routerLink="/media" (click)="toggleMobileMenu()"
            class="p-button-text p-button-secondary tw-block tw-w-full" [label]="t('homeHeader.movies')"></button>
          <button role="navigation" pButton routerLink="/media" (click)="toggleMobileMenu()"
            class="p-button-text p-button-secondary tw-block tw-w-full" [label]="t('homeHeader.tvShows')"></button>
          <button *ngIf="!currentUser; else loggedIn" role="navigation" pButton routerLink="/sign-in"
            (click)="toggleMobileMenu()" class="p-button-text p-button-secondary tw-block tw-w-full"
            [label]="t('homeHeader.signIn')"></button>
          <ng-template #loggedIn>
            <button role="button" pButton (click)="toggleMobileMenu(); onSignOut()"
              class="p-button-text p-button-secondary tw-block tw-w-full" [label]="t('homeHeader.signOut')"></button>
          </ng-template>
        </div>
      </div> -->
    </nav>

    <p-altSidebar #sidebar [(visible)]="displaySidebar" [blockScroll]="true" styleClass="!tw-w-full xs:!tw-w-64"
      contentStyleClass="p-scrollbar [&>*>button]:tw-w-full [&>*>button]:!tw-text-left" contentId="sidebar-menu-content"
      (visibleChange)="onSidebarVisibleChange($event)" ariaCloseLabel="Close side menu">
      <ng-template pTemplate="header">
        <ng-container *ngIf="currentUser; else notLoggedIn">
          <a type="button" role="navigation" aria-label="User profile" class="tw-flex tw-items-center tw-rounded-md
              tw-p-1 tw-bg-neutral-675 hover:tw-bg-neutral-650 tw-transition-colors tw-duration-200
              tw-shadow tw-w-full tw-mx-2" [routerLink]="['/users', currentUser._id]">
            <ng-container *ngTemplateOutlet="userButton; context: { currentUser }"></ng-container>
          </a>
        </ng-container>
        <ng-template #notLoggedIn>
          <p class="tw-p-1 tw-w-full tw-mx-2">{{ t('homeHeader.notSignedIn') }}</p>
        </ng-template>
      </ng-template>
      <ng-template pTemplate="content">
        <a class="tw-block" routerLink="/">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.home')"></button>
        </a>
        <a class="tw-block" routerLink="/search">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.search')"></button>
        </a>
        <a class="tw-block" routerLink="/list/movie">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.movies')"></button>
        </a>
        <a class="tw-block" routerLink="/list/tv">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.tvShows')"></button>
        </a>
        <button pButton class="p-button-text p-button-secondary tw-w-full tw-text-left" [label]="t('homeHeader.genres')"
          [icon]="'ms ms-' + (displaySidebarGenres ? 'expand-less' : 'expand-more')" iconPos="right"
          (click)="displaySidebarGenres = !displaySidebarGenres"></button>
        <div *ngIf="displaySidebarGenres" class="tw-px-2">
          <div infiniteScroll [infiniteScrollDistance]="2"
            [infiniteScrollDisabled]="!genreList?.hasNextPage || !displaySidebarGenres" [fromRoot]="true"
            infiniteScrollContainer="#sidebar-menu-content" (scrolled)="onScroll()">
            <ng-container *ngIf="!loadingGenres && genreList; else loadingGenresTpl">
              <a *ngFor="let genre of genreList.results; trackBy: track_Id" class="tw-block"
                [routerLink]="['/list', 'genre', genre._id]">
                <button role="navigation" pButton
                  class="p-button-text p-button-secondary tw-block tw-w-full tw-text-left tw-text-sm tw-truncate"
                  [label]="genre.name"></button>
              </a>
            </ng-container>
            <ng-container *ngIf="loadingMoreGenres; then loadingGenresTpl"></ng-container>
          </div>
          <ng-template #loadingGenresTpl>
            <div class="tw-px-3 tw-py-3.5" *ngFor="let item of skeletonArray">
              <app-skeleton width="100%" height="14.83px"></app-skeleton>
            </div>
          </ng-template>
        </div>
        <a class="tw-block" routerLink="/list/added">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.added')"></button>
        </a>
        <a class="tw-block" routerLink="/list/newReleases">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.newReleases')"></button>
        </a>
        <a class="tw-block" routerLink="/list/updated">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.updated')"></button>
        </a>
        <a class="tw-block" routerLink="/list/mostViewed">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.mostViewed')"></button>
        </a>
        <a class="tw-block" routerLink="/list/topRated">
          <button role="navigation" pButton class="p-button-text p-button-secondary"
            [label]="t('homeHeader.topRated')"></button>
        </a>
      </ng-template>
      <ng-template pTemplate="footer">
        <button *ngIf="currentUser; else notLoggedIn" role="button" pButton (click)="onSignOut()"
          class="p-button-sm p-button-secondary p-button-shrink tw-w-full" icon="ms ms-logout"
          [label]="t('homeHeader.signOut')"></button>
        <ng-template #notLoggedIn>
          <a class="tw-block tw-w-full" routerLink="/sign-in">
            <button role="navigation" pButton class="p-button-sm p-button-secondary p-button-shrink tw-w-full"
              icon="ms ms-logout" [label]="t('homeHeader.signIn')"></button>
          </a>
        </ng-template>
      </ng-template>
    </p-altSidebar>

    <div #menuZone></div>
    <ng-template #desktopMenu>
      <div appMenu class="[&>*]:tw-font-medium">
        <a appMenuItem routerLink="/">{{ t('homeHeader.home') }}</a>
        <a appMenuItem routerLink="/search">{{ t('homeHeader.search') }}</a>
        <a appMenuItem routerLink="/list/movie">{{ t('homeHeader.movies') }}</a>
        <a appMenuItem routerLink="/list/tv">{{ t('homeHeader.tvShows') }}</a>
        <button appMenuItem [appMenuTriggerFor]="desktopGenresMenu">{{ t('homeHeader.genres')
          }}</button>
        <a appMenuItem routerLink="/list/added">{{ t('homeHeader.added') }}</a>
        <a appMenuItem routerLink="/list/newReleases">{{ t('homeHeader.newReleases') }}</a>
        <a appMenuItem routerLink="/list/updated">{{ t('homeHeader.updated') }}</a>
        <a appMenuItem routerLink="/list/mostViewed">{{ t('homeHeader.mostViewed') }}</a>
        <a appMenuItem routerLink="/list/topRated">{{ t('homeHeader.topRated') }}</a>
      </div>
    </ng-template>
    <ng-template #desktopGenresMenu>
      <div appMenu class="p-scrollbar tw-flex-wrap tw-flex-row tw-w-[38rem] tw-max-h-96 tw-overflow-y-auto"
        infiniteScroll [infiniteScrollDistance]="2" [infiniteScrollDisabled]="!genreList?.hasNextPage"
        [scrollWindow]="false" (scrolled)="onScroll()">
        <ng-container *ngIf="!loadingGenres && genreList; else loadingGenresTpl">
          <a *ngFor="let genre of genreList.results; trackBy: track_Id"
            class="cdk-menu-item-sm !tw-block tw-w-1/4 tw-text-sm tw-truncate" appMenuItem
            [routerLink]="['/list', 'genre', genre._id]">{{ genre.name }}</a>
        </ng-container>
        <ng-container *ngIf="loadingMoreGenres; then loadingGenresTpl"></ng-container>
      </div>
      <ng-template #loadingGenresTpl>
        <div class="tw-w-1/4 tw-px-3 tw-py-2.5" *ngFor="let item of skeletonArray">
          <app-skeleton width="100%" height="16px"></app-skeleton>
        </div>
      </ng-template>
    </ng-template>

    <ng-template #userButton let-currentUser="currentUser">
      <div class="tw-w-9">
        <div class="tw-aspect-w-1 tw-aspect-h-1 tw-rounded-full [&>*]:tw-rounded-full tw-overflow-hidden
            tw-flex-shrink-0">
          <img *ngIf="currentUser.smallAvatarUrl; else noAvatar" class="tw-object-cover"
            [lazyLoad]="currentUser.smallAvatarUrl" [lazyLoadPlaceholder]="currentUser.avatarColor | rgbColor"
            [alt]="currentUser.username">
          <ng-template #noAvatar>
            <span class="tw-text-white ms ms-account-circle ms-opsz-lg tw-text-4xl tw-leading-9"></span>
          </ng-template>
        </div>
      </div>
      <p class="tw-text-white tw-font-medium tw-mx-2 tw-max-w-[6rem] tw-truncate">{{ currentUser.username
        }}</p>
    </ng-template>
  </ng-container>
  <div *ngIf="isFixedNavbar && navbarSpacing" class="tw-h-14"></div>
</header>
